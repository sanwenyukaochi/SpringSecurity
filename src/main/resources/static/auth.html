<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>用户注册与登录</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --fg: #e5e7eb;
            --accent: #10b981;
            --danger: #ef4444;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg);
            color: var(--fg);
        }

        .container {
            max-width: 980px;
            margin: 32px auto;
            padding: 0 16px;
        }

        h1 {
            font-size: 22px;
            margin-bottom: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .card {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            font-size: 18px;
            margin: 0 0 12px;
        }

        label {
            display: block;
            font-size: 13px;
            margin: 8px 0 4px;
            color: #9ca3af;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #0b1220;
            color: var(--fg);
        }

        input:focus {
            outline: none;
            border-color: #4b5563;
        }

        button {
            margin-top: 12px;
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: var(--accent);
            color: #052e2b;
            font-weight: 600;
        }

        button.secondary {
            background: #3b82f6;
            color: #061b3b;
        }

        button.danger {
            background: var(--danger);
            color: #3a0c0c;
        }

        .row {
            display: flex;
            gap: 8px;
        }

        .muted {
            color: #9ca3af;
            font-size: 12px;
        }

        .log {
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            background: #0b1220;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px;
            min-height: 80px;
        }

        .section {
            margin-top: 24px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Spring Security 示例：发送邮箱验证码、注册用户、登录</h1>
    <p class="muted">后端接口基于你项目中的 LoginController 与登录过滤器（Username/Email/SMS）。统一返回结构为 Result{
        code, message, data }。</p>

    <div class="grid">
        <!-- 发送邮箱验证码 -->
        <div class="card">
            <h2>发送邮箱验证码</h2>
            <label>用户名（唯一）</label>
            <input id="send-username" placeholder="admin_user"/>
            <label>邮箱</label>
            <input id="send-email" type="email" placeholder="admin@example.com"/>
            <button id="btn-send-email">发送验证码</button>
            <p class="muted">服务器会发送固定验证码 000000 到你的邮箱（示例逻辑）。</p>
        </div>

        <!-- 注册用户（邮箱验证码） -->
        <div class="card">
            <h2>注册用户</h2>
            <label>用户名</label>
            <input id="signup-username" placeholder="admin_user"/>
            <label>密码</label>
            <input id="signup-password" type="password" placeholder="123456"/>
            <label>邮箱</label>
            <input id="signup-email" type="email" placeholder="admin@example.com"/>
            <label>验证码</label>
            <input id="signup-code" placeholder="000000"/>
            <button id="btn-signup">注册</button>
            <p class="muted">校验规则：用户名与邮箱未占用，验证码必须为 000000。</p>
        </div>

        <!-- 登录（用户名或邮箱） -->
        <div class="card">
            <h2>登录</h2>
            <div class="row">
                <button class="secondary" id="tab-username">用户名登录</button>
                <button class="secondary" id="tab-email">邮箱登录</button>
                <button class="secondary" id="tab-sms">短信登录（可选）</button>
            </div>
            <div id="login-username-panel" class="section">
                <label>用户名</label>
                <input id="login-username" placeholder="admin_user"/>
                <label>密码</label>
                <input id="login-password" type="password" placeholder="123456"/>
                <button id="btn-login-username">登录（用户名）</button>
            </div>
            <div id="login-email-panel" class="section" style="display:none">
                <label>邮箱</label>
                <input id="login-email" type="email" placeholder="admin@example.com"/>
                <label>密码</label>
                <input id="login-email-password" type="password" placeholder="123456"/>
                <button id="btn-login-email">登录（邮箱）</button>
            </div>
            <div id="login-sms-panel" class="section" style="display:none">
                <label>手机号</label>
                <input id="login-phone" placeholder="13800000000"/>
                <label>短信验证码</label>
                <input id="login-captcha" placeholder="889900"/>
                <button id="btn-login-sms">登录（短信）</button>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="card">
            <h2>操作日志 / 返回结果</h2>
            <div id="log" class="log"></div>
            <div class="row">
                <button id="btn-clear" class="danger">清空日志</button>
                <button id="btn-test-protected" class="secondary">使用token访问受保护接口（示例）</button>
            </div>
            <p class="muted">成功登录后会将 token 保存到 localStorage.token。示例受保护接口：GET
                /open-api/business-1（请根据后端实际实现调整）。</p>
        </div>
    </div>
</div>

<script>
    const logEl = document.getElementById('log');
    const log = (msg, obj) => {
        const time = new Date().toLocaleTimeString();
        logEl.textContent += `\n[${time}] ${msg}`;
        if (obj !== undefined) {
            logEl.textContent += `\n${JSON.stringify(obj, null, 2)}\n`;
        }
        logEl.scrollTop = logEl.scrollHeight;
    };
    const clearLog = () => {
        logEl.textContent = '';
    };

    // 切换登录方式 Tab
    document.getElementById('tab-username').addEventListener('click', () => {
        document.getElementById('login-username-panel').style.display = '';
        document.getElementById('login-email-panel').style.display = 'none';
        document.getElementById('login-sms-panel').style.display = 'none';
    });
    document.getElementById('tab-email').addEventListener('click', () => {
        document.getElementById('login-username-panel').style.display = 'none';
        document.getElementById('login-email-panel').style.display = '';
        document.getElementById('login-sms-panel').style.display = 'none';
    });
    document.getElementById('tab-sms').addEventListener('click', () => {
        document.getElementById('login-username-panel').style.display = 'none';
        document.getElementById('login-email-panel').style.display = 'none';
        document.getElementById('login-sms-panel').style.display = '';
    });

    // 统一的请求发送函数
    async function apiFetch(url, method, body) {
        const resp = await fetch(url, {
            method,
            headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
            body: body ? JSON.stringify(body) : undefined,
        });
        const json = await resp.json().catch(() => ({}));
        return {status: resp.status, json};
    }

    // 发送邮箱验证码
    document.getElementById('btn-send-email').addEventListener('click', async () => {
        const username = document.getElementById('send-username').value.trim();
        const email = document.getElementById('send-email').value.trim();
        if (!username || !email) {
            return log('请完整填写 用户名/密码/邮箱');
        }
        const {status, json} = await apiFetch('/api/user/signup/application/sendEmail', 'POST', {
            username,
            email
        });
        log(`发送验证码 -> 状态: ${status}`, json);
    });

    // 注册用户
    document.getElementById('btn-signup').addEventListener('click', async () => {
        const username = document.getElementById('signup-username').value.trim();
        const password = document.getElementById('signup-password').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const code = document.getElementById('signup-code').value.trim();
        if (!username || !password || !email || !code) {
            return log('请完整填写 用户名/密码/邮箱/验证码');
        }
        const {status, json} = await apiFetch('/api/user/signup/application/email', 'POST', {
            username,
            password,
            email,
            code
        });
        log(`注册用户 -> 状态: ${status}`, json);
    });

    // 用户名登录
    document.getElementById('btn-login-username').addEventListener('click', async () => {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        if (!username || !password) {
            return log('请填写用户名与密码');
        }
        const {status, json} = await apiFetch('/user/login/application/username', 'POST', {username, password});
        log(`用户名登录 -> 状态: ${status}`, json);
        if (json && json.code === 'success' && json.data && json.data.token) {
            localStorage.setItem('token', json.data.token);
            log('token 已保存到 localStorage.token');
        }
    });

    // 邮箱登录
    document.getElementById('btn-login-email').addEventListener('click', async () => {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-email-password').value.trim();
        if (!email || !password) {
            return log('请填写邮箱与密码');
        }
        const {status, json} = await apiFetch('/user/login/application/email', 'POST', {email, password});
        log(`邮箱登录 -> 状态: ${status}`, json);
        if (json && json.code === 'success' && json.data && json.data.token) {
            localStorage.setItem('token', json.data.token);
            log('token 已保存到 localStorage.token');
        }
    });

    // 短信登录（如果后端已配置该过滤器与Provider）
    document.getElementById('btn-login-sms').addEventListener('click', async () => {
        const phone = document.getElementById('login-phone').value.trim();
        const captcha = document.getElementById('login-captcha').value.trim();
        if (!phone || !captcha) {
            return log('请填写手机号与短信验证码');
        }
        const {status, json} = await apiFetch('/user/login/application/sms', 'POST', {phone, captcha});
        log(`短信登录 -> 状态: ${status}`, json);
        if (json && json.code === 'success' && json.data && json.data.token) {
            localStorage.setItem('token', json.data.token);
            log('token 已保存到 localStorage.token');
        }
    });

    // 清空日志
    document.getElementById('btn-clear').addEventListener('click', clearLog);

    // 示例：携带 token 调用受保护接口
    document.getElementById('btn-test-protected').addEventListener('click', async () => {
        const token = localStorage.getItem('token');
        if (!token) return log('尚未登录或未获得 token');
        const resp = await fetch('/open-api/business-1', {
            method: 'GET',
            headers: {'Authorization': `Bearer ${token}`}
        });
        const text = await resp.text();
        log(`访问受保护接口 -> 状态: ${resp.status}\n返回:`, text);
    });
</script>
</body>
</html>