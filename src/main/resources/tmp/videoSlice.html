<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSocket Video Slice Test</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket 视频切片测试</h2>

<label>JWT Token：</label><br>
<input type="text" id="jwt" placeholder="输入 JWT Token" style="width: 400px" /><br><br>

<label>视频 ID（多个以英文逗号分隔）：</label><br>
<input type="text" id="videoIds" placeholder="例如: 1234567890,9876543210" style="width: 400px" /><br><br>

<button onclick="connect()">连接</button>
<button onclick="disconnect()">断开连接</button>
<button onclick="sendSliceRequest()">发送切片请求</button>
<pre id="output"></pre>

<script>
  let stompClient = null;

  function connect() {
      const socket = new SockJS("http://localhost:8080/portfolio");
      stompClient = Stomp.over(socket);
      
      const jwt = document.getElementById('jwt').value;
      
      stompClient.connect({ Authorization: 'Bearer ' + jwt }, function (frame) {
          document.getElementById("output").innerText += "连接成功: " + frame + "\n";

          stompClient.subscribe("/user/queue/video-slice/result", function (message) {
              document.getElementById("output").innerText += "收到响应:\n" + message.body + "\n";
          });
      }, function (error) {
          document.getElementById("output").innerText += "连接失败: " + error + "\n";
      });
  }

  function disconnect() {
      if (stompClient && stompClient.connected) {
          stompClient.disconnect(function () {
              document.getElementById("output").innerText += "已断开连接\n";
          });
      } else {
          document.getElementById("output").innerText += "未连接，无需断开\n";
      }
  }

  function sendSliceRequest() {
      if (!stompClient || !stompClient.connected) {
          document.getElementById("output").innerText += "请先连接 WebSocket！\n";
          return;
      }

      const rawIds = document.getElementById("videoIds").value;
      if (!rawIds) {
          document.getElementById("output").innerText += "请输入至少一个视频 ID\n";
          return;
      }

      const ids = rawIds.split(",").map(id => id.trim()).filter(id => id);

      const payload = {
          ids: ids,
          taskType: "SLICE",
          videoType: "livestream",
          adaptiveThreshold: 30,
          addSubtitle: true
      };
      stompClient.send("/app/video/slice/create", {}, JSON.stringify(payload));
      document.getElementById("output").innerText += "发送切片请求:\n" + JSON.stringify(payload, null, 2) + "\n";
  }
</script>
</body>
</html>
